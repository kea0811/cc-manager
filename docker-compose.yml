services:
  mongodb:
    image: mongo:7
    ports:
      - "27018:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ccadmin
      MONGO_INITDB_ROOT_PASSWORD: ccmanager2024
      MONGO_INITDB_DATABASE: cc_manager
    volumes:
      - mongodb-data:/data/db
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - MONGODB_URI=mongodb://ccadmin:ccmanager2024@192.168.50.74:27018/cc_manager?authSource=admin
      - WORKSPACE_PATH=/workspace
      # Support both token variable names for compatibility
      - CLAUDE_CODE_TOKEN=${CLAUDE_CODE_TOKEN:-}
      - CLAUDE_CODE_OAUTH_TOKEN=${CLAUDE_CODE_TOKEN:-}
      # SSH private key for git operations (base64 encoded)
      - SSH_PRIVATE_KEY=${SSH_PRIVATE_KEY:-}
    volumes:
      - cc-workspace:/workspace
      # Mount Docker socket for spawning development containers
      - /var/run/docker.sock:/var/run/docker.sock
      # SSH key is passed via environment variable SSH_PRIVATE_KEY
      # Mount the claude-project directory for deployments
      - /volume1/docker/claude-project:/volume1/docker/claude-project
      # Optional: Mount Claude config directory
      # - ~/.claude:/home/claudeuser/.claude
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "3003:80"
    depends_on:
      - backend
    environment:
      - VITE_API_URL=http://backend:3001
    restart: unless-stopped

  # E2E Test Backend - uses test MongoDB database on NAS
  backend-test:
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      - NODE_ENV=production
      - MONGODB_URI=mongodb://ccadmin:ccmanager2024@192.168.50.74:27018/cc_manager_test?authSource=admin
      - CLAUDE_CODE_TOKEN=${CLAUDE_CODE_TOKEN:-}
      - CLAUDE_CODE_OAUTH_TOKEN=${CLAUDE_CODE_TOKEN:-}
    profiles:
      - test

  # E2E Test Frontend - points to test backend
  frontend-test:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    depends_on:
      - backend-test
    environment:
      - VITE_API_URL=http://backend-test:3001
    profiles:
      - test

  # E2E Tests - run with: docker compose --profile test up e2e-tests
  e2e-tests:
    image: mcr.microsoft.com/playwright:v1.57.0-jammy
    working_dir: /app
    entrypoint: /bin/bash
    command: -c "npm install --silent && npx playwright test --reporter=list"
    volumes:
      - ./frontend:/app
    environment:
      - BASE_URL=http://frontend-test:80
    depends_on:
      - frontend-test
      - backend-test
    networks:
      - default
    profiles:
      - test

volumes:
  cc-workspace:
  mongodb-data:
